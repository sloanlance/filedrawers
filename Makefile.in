SHELL = /bin/sh

srcdir =        .

OPTOPTS=        -Wall -Wmissing-prototypes -Wstrict-prototypes
CC=             gcc
INSTALL=        @INSTALL@

# Configured directory names
ROOTDIR=@prefix@/@project_name@
SHTMLDIR=${ROOTDIR}/@shtml_dir_name@
HTMLDIR=${ROOTDIR}/@html_dir_name@
OBJECTS=${ROOTDIR}/@object_dir_name@
SMARTY=${ROOTDIR}/@smarty_dir_name@
CGIDIR=${ROOTDIR}/@cgi_dir_name@

# Derived directory names
SIMAGES=${SHTMLDIR}/images
JSDIR=${SHTMLDIR}/js
MWSDIR=${SHTMLDIR}/make-webspace
ASDIR=${SHTMLDIR}/allow-support
ADMINDIR=${SHTMLDIR}/admin-support
IMAGES=${HTMLDIR}/images
DOWNLOADDIR=${SHTMLDIR}/download
TEMPLATES=${SMARTY}/templates
TEMPLATES_C=${SMARTY}/templates_c

CFLAGS=         ${OPTOPTS} -g -O2

SHTMLDIRTARGET= css/fileman.css css/ie6specific.css css/ie5specific.css \
                css/favorites.css css/makewebspace.css \
		css/allowsupport.css css/adminsupport.css \
                php/addfavorites.php php/deletefavorites.php \
                php/perm_manager.php php/progress.php \
                php/renamefavorites.php php/viewfavorites.php \
                php/blankpage.html

HTMLDIRTARGET=  css/styles.css php/feedback.php

OBJECTSTARGET=  php/afs.php php/favorites.php php/mime.php \
                php/webspaces.php php/affiliations.php \
		php/supportgroups.php php/config.php

SMARTYTARGET=   smarty/smarty.custom.php

TEMPLATETARGET= smarty/fileman.tpl smarty/makewebspace.tpl \
                smarty/allowsupport.tpl smarty/adminsupport.tpl \
		smarty/adminsupport_noauth.tpl \
                smarty/addFavorites.tpl smarty/deleteFavorites.tpl \
                smarty/footer.tpl smarty/masthead.tpl \
                smarty/permissions.tpl smarty/renameFavorites.tpl \
                smarty/viewFavorites.tpl smarty/sidebar.tpl \
                smarty/filelist.tpl smarty/fileman.tpl \

SIMAGETARGET=   images/checkbox.gif images/doc_lg.gif \
                images/doc_sm.gif images/download.gif \
                images/folder.gif images/folder_locked.gif \
                images/sort_ascend.gif images/sort_decend.gif \
                images/text.gif images/support_remove.gif \
                images/support_give.gif

IMAGETARGET=    images/blue_tabcap_r.gif images/bulb_large.gif \
                images/bulb_small.gif images/first_time.gif \
                images/header_afs_cabinet.gif images/header_text_afs.gif \
                images/link_arrow.gif images/login-anim.gif \
                images/searchtab_l.gif images/searchtab_r.gif \
                images/spacer.gif

JSDIRTARGET=    js/filemanage.js js/allowsupport.js

all: php/config.php upload/upload.cgi

upload/upload.cgi: libcgi/libcgi.a upload/upload.o
	${CC} ${CFLAGS} -o upload/upload.cgi upload/upload.o -Llibcgi -lcgi

upload/upload.o: upload/tpupload.c
	${CC} ${CFLAGS} ${OPTOPTS} \
	-Ilibcgi \
	-D_URL_ERROR_PAGE=\"@error_url@\" \
	-c upload/tpupload.c -o upload/upload.o

libcgi/libcgi.a:
	cd libcgi; ${MAKE} ${MFLAGS}

php/config.php:
	rm -f php/config.php
	echo '<?php' >> php/config.php
	echo '# php config file generated by Makefile.' >> php/config.php
	echo "\$$service_name = \"@service_name@\";" >> php/config.php
	echo "\$$service_url = \"@service_url@\";" >> php/config.php
	echo "\$$secure_service_url = \"@secure_service_url@\";" >> \
	     php/config.php
	echo '?>' >> php/config.php

install: all
	mkdir -p ${ROOTDIR}
	chmod 775 ${ROOTDIR}
	chgrp @install_group@ ${ROOTDIR}

	mkdir -p ${SHTMLDIR}
	chmod 775 ${SHTMLDIR}
	chgrp @install_group@ ${SHTMLDIR}
	for i in ${SHTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SHTMLDIR}/; \
	done

	# Copy filemanager index into shtml index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_filemanager.php \
	           ${SHTMLDIR}/index.php

        # Install shtml Images
	mkdir -p ${SIMAGES}
	chmod 0775 ${SIMAGES}
	chgrp @install_group@ ${SIMAGES}
	for i in ${SIMAGETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${SIMAGES}/; \
	done

        # Install mime images.
	cp -R images/mime ${SIMAGES}
	chmod -R 0775 ${SIMAGES}/mime
	chgrp -R @install_group@ ${SIMAGES}/mime

	mkdir -p ${HTMLDIR}
	chmod 775 ${HTMLDIR}
	chgrp @install_group@ ${HTMLDIR}
	for i in ${HTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${HTMLDIR}/; \
	done

	# Copy html index into html index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_html.php \
	           ${HTMLDIR}/index.php

	mkdir -p ${JSDIR}
	chmod 775 ${JSDIR}
	chgrp @install_group@ ${JSDIR}
	for i in ${JSDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${JSDIR}/; \
	done

	mkdir -p ${OBJECTS}
	chmod 775 ${OBJECTS}
	chgrp @install_group@ ${OBJECTS}
	for i in ${OBJECTSTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${OBJECTS}/; \
	done

        # Install html Images
	mkdir -p ${IMAGES}
	chmod 0775 ${IMAGES}
	chgrp @install_group@ ${IMAGES}
	for i in ${IMAGETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${IMAGES}/; \
	done

	mkdir -p ${SMARTY}
	chmod 775 ${SMARTY}
	chgrp @install_group@ ${SMARTY}
	for i in ${SMARTYTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SMARTY}/; \
	done

        # Create smarty templates directory
	mkdir -p ${TEMPLATES}
	chgrp @install_group@ ${TEMPLATES}
	chmod 777 ${TEMPLATES}

	for i in ${TEMPLATETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${TEMPLATES}/; \
	done

	mkdir -p ${TEMPLATES_C}
	chgrp @install_group@ ${TEMPLATES_C}
	chmod 777 ${TEMPLATES_C}

	mkdir -p ${DOWNLOADDIR}
	chmod 775 ${DOWNLOADDIR}
	chgrp @install_group@ ${DOWNLOADDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_download.php \
	           ${DOWNLOADDIR}/index.php

	mkdir -p ${CGIDIR}
	chmod 755 ${CGIDIR}
	chgrp @install_group@ ${CGIDIR}
	$(INSTALL) -g @install_group@ -m 0775 upload/upload.cgi \
	           ${CGIDIR}/upload.cgi

        # Install make-webspace
	mkdir -p ${MWSDIR}
	chmod 755 ${MWSDIR}
	chgrp @install_group@ ${MWSDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_makewebspace.php \
	           ${MWSDIR}/index.php

        # Install allow-support
	mkdir -p ${ASDIR}
	chmod 755 ${ASDIR}
	chgrp @install_group@ ${ASDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_allowsupport.php \
	           ${ASDIR}/index.php

        # Install admin-support
	mkdir -p ${ADMINDIR}
	chmod 755 ${ADMINDIR}
	chgrp @install_group@ ${ADMINDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_adminsupport.php \
	           ${ADMINDIR}/index.php

clean :
	cd libcgi; ${MAKE} ${MFLAGS} clean
	rm -f upload/*.o upload/a.out upload/*.core upload/upload.cgi
	rm -f php/config.php
