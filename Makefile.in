SHELL = /bin/sh

srcdir =        .

OPTOPTS=        -Wall -Wmissing-prototypes
CC=             gcc
INSTALL=        @INSTALL@

prefix=@prefix@

# These directory names need to be defined with ./configure options.

ROOTDIR=@prefix@
SHTMLDIR=@prefix@/html-ssl
SIMAGES=${SHTMLDIR}/images
HTMLDIR=@prefix@/html
IMAGES=${HTMLDIR}/images
DOWNLOADDIR=${SHTMLDIR}/download
OBJECTS=@prefix@/objects
SMARTY=@prefix@/smarty
TEMPLATES=${SMARTY}/templates
WWWROOT=${TEMPLATES}/wwwroot
PIECES=${TEMPLATES}/pieces
TEMPLATES_C=${SMARTY}/templates_c
CGIDIR=@prefix@/cgi-ssl

CFLAGS=         ${OPTOPTS} -g -O2

SHTMLDIRTARGET=  css/fileman.css css/ie6specific.css css/ie5specific.css \
		php/addfavorites.php php/deletefavorites.php \
		php/perm_manager.php php/progress.php \
		php/renamefavorites.php php/viewfavorites.php

HTMLDIRTARGET=  css/styles.css php/feedback.php

OBJECTSTARGET=  php/afs.php php/favorites.php php/mime.php

SMARTYTARGET=   smarty/smarty.custom.php

WWWROOTTARGET=  smarty/fileman.tpl

PIECESTARGET=   smarty/addFavorites.tpl smarty/deleteFavorites.tpl \
		smarty/footer.tpl smarty/masthead.tpl \
		smarty/permissions.tpl smarty/renameFavorites.tpl \
		smarty/viewFavorites.tpl

SIMAGETARGET=   images/checkbox.gif images/doc_lg.gif \
                images/doc_sm.gif images/download.gif \
		images/folder.gif images/folder_locked.gif \
		images/sort_ascend.gif images/sort_decend.gif \
		images/text.gif

IMAGETARGET=    images/blue_tabcap_r.gif images/bulb_large.gif \
                images/bulb_small.gif images/first_time.gif \
		images/header_afs_cabinet.gif images/header_text_afs.gif \
		images/link_arrow.gif images/login-anim.gif \
		images/searchtab_l.gif images/searchtab_r.gif \
		images/spacer.gif

all:
	cd libcgi; make all
	cd upload; make all

FRC :

libcgi/libcgi.a : FRC
	cd libcgi; ${MAKE} ${MFLAGS} CC=${CC} 

upload/tpupload.o : FRC
	cd upload; ${MAKE} ${MFLAGS} CC=${CC}

install: all
	mkdir -p ${ROOTDIR}
	chmod 775 ${ROOTDIR}

	mkdir -p ${SHTMLDIR}
	chmod 775 ${SHTMLDIR}
	for i in ${SHTMLDIRTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${SHTMLDIR}/; \
	done

	# Copy filemanager index into shtml index.
	$(INSTALL) -m 0775 php/index_filemanager.php ${SHTMLDIR}/index.php

        # Install shtml Images
	mkdir -p ${SIMAGES}
	chmod 0775 ${SIMAGES}
	for i in ${SIMAGETARGET}; do \
		$(INSTALL) -m 0664 -c $$i ${SIMAGES}/; \
	done

        # Install mime images
	cp -R images/mime ${SIMAGES}
	chmod -R 0775 ${SIMAGES}/mime

	mkdir -p ${HTMLDIR}
	chmod 775 ${HTMLDIR}
	for i in ${HTMLDIRTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${HTMLDIR}/; \
	done

	# Copy html index into html index.
	$(INSTALL) -m 0775 php/index_html.php ${HTMLDIR}/index.php

	mkdir -p ${OBJECTS}
	chmod 775 ${OBJECTS}
	for i in ${OBJECTSTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${OBJECTS}/; \
	done

        # Install html Images
	mkdir -p ${IMAGES}
	chmod 0775 ${IMAGES}
	for i in ${IMAGETARGET}; do \
		$(INSTALL) -m 0664 -c $$i ${IMAGES}/; \
	done

	mkdir -p ${SMARTY}
	chmod 775 ${SMARTY}
	for i in ${SMARTYTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${SMARTY}/; \
	done

	mkdir -p ${TEMPLATES}
	chmod 775 ${TEMPLATES}

	mkdir -p ${WWWROOT}
	chmod 775 ${WWWROOT}
	for i in ${WWWROOTTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${WWWROOT}/; \
	done

	mkdir -p ${PIECES}
	chmod 775 ${PIECES}
	for i in ${PIECESTARGET}; do \
		$(INSTALL) -m 0775 -c $$i ${PIECES}/; \
	done

	mkdir -p ${TEMPLATES_C}
	chmod 775 ${TEMPLATES_C}

	mkdir -p ${DOWNLOADDIR}
	chmod 775 ${DOWNLOADDIR}
	$(INSTALL) -m 0775 php/index_download.php ${DOWNLOADDIR}/index.php

	mkdir -p ${CGIDIR}
	chmod 755 ${CGIDIR}
	$(INSTALL) -m 0775 upload/upload.cgi ${CGIDIR}/upload.cgi

clean :
	cd libcgi; ${MAKE} ${MFLAGS} clean
	cd upload; ${MAKE} ${MFLAGS} clean
