SHELL = /bin/sh

srcdir =        .

OPTOPTS=        -Wall -Wmissing-prototypes -Wstrict-prototypes
CC=             gcc
INSTALL=        @INSTALL@

# Configured directory names
ROOTDIR=@prefix@/@project_name@
SHTMLDIR=${ROOTDIR}/@shtml_dir_name@
HTMLDIR=${ROOTDIR}/@html_dir_name@
OBJDIR=${ROOTDIR}/@object_dir_name@
SMARTY=${ROOTDIR}/@smarty_dir_name@
CGIDIR=${ROOTDIR}/@cgi_dir_name@
LIBDIR=${ROOTDIR}/@lib_dir_name@
JSDIR=${ROOTDIR}/@js_dir_name@
CSSDIR=${ROOTDIR}/@css_dir_name@
IMAGES=${ROOTDIR}/images

# Derived directory names
MWSDIR=${SHTMLDIR}/make-webspace
ASDIR=${SHTMLDIR}/allow-support
ADMINDIR=${SHTMLDIR}/admin-support
DOWNLOADDIR=${SHTMLDIR}/download
TEMPLATES=${SMARTY}/templates
TEMPLATES_C=${SMARTY}/templates_c

ifeq (@custom_sess_path@,)
	SESSPATH=${ROOTDIR}/upload-session
else
	SESSPATH=@custom_sess_path@/upload-session
endif

CFLAGS=         ${OPTOPTS} -g -O2

SHTMLDIRTARGET= php/addfavorites.php php/deletefavorites.php \
                php/perm_manager.php php/progress.php \
                php/renamefavorites.php php/viewfavorites.php \
                php/blankpage.html php/scripterror.php php/help.php \
                php/scriptversion.php php/view.php \
				php/upload-info-server.php php/missinghomedir.php

HTMLDIRTARGET=  php/feedback.php

OBJDIRTARGET=   php/afs.php php/favorites.php php/mime.php \
                php/webspaces.php php/affiliations.php \
                php/supportgroups.php

LIBDIRTARGET=   php/config.php php/libdrawers.php \
                php/version.php

SMARTYTARGET=   smarty/smarty.custom.php

TEMPLATETARGET= smarty/fileman.tpl smarty/makewebspace.tpl \
                smarty/allowsupport.tpl smarty/adminsupport.tpl \
                smarty/adminsupport_noauth.tpl \
                smarty/addFavorites.tpl smarty/deleteFavorites.tpl \
                smarty/footer.tpl smarty/masthead.tpl \
                smarty/permissions.tpl smarty/renameFavorites.tpl \
                smarty/viewFavorites.tpl smarty/sidebar.tpl \
                smarty/filelist.tpl smarty/fileman.tpl \
                smarty/banner.tpl smarty/infobar.tpl \
				smarty/scripterror.tpl smarty/header.tpl \
				smarty/help.tpl smarty/scriptversion.tpl \
				smarty/viewfile.tpl smarty/missinghomedir.tpl

IMAGETARGET=    images/checkbox.gif images/doc_lg.gif \
                images/doc_sm.gif images/download.gif \
                images/folder.gif images/folder_locked.gif \
                images/sort_ascend.gif images/sort_decend.gif \
                images/text.gif images/support_remove.gif \
                images/support_give.gif \
                images/blue_tabcap_r.gif images/bulb_large.gif \
                images/bulb_small.gif images/first_time.gif \
                images/header_afs_cabinet.gif images/header_text_afs.gif \
                images/link_arrow.gif images/login-anim.gif \
                images/searchtab_l.gif images/searchtab_r.gif \
                images/spacer.gif

JSDIRTARGET=    js/filemanage.js js/allowsupport.js

CSSDIRTARGET=   css/adminsupport.css css/allowsupport.css \
		css/favorites.css css/fileman.css \
		css/ie5specific.css css/ie6specific.css \
		css/makewebspace.css css/styles.css

all: php/version.php php/config.php upload/upload.cgi

upload/upload.cgi: libcgi/libcgi.a upload/upload.o
	${CC} ${CFLAGS} -o upload/upload.cgi upload/upload.o -Llibcgi -lcgi

upload/upload.o: upload/tpupload.c Makefile
	${CC} ${CFLAGS} ${OPTOPTS} \
	-Ilibcgi \
	-D_URL_ERROR_PAGE=\"@error_url@\" \
	-DSESSION_PATH=\"${SESSPATH}\" \
	-c upload/tpupload.c -o upload/upload.o

libcgi/libcgi.a:
	cd libcgi; ${MAKE} ${MFLAGS}

php/config.php: Makefile
	rm -f php/config.php
	echo '<?php' >> php/config.php
	echo '# php config file generated by Makefile.' >> php/config.php
	echo "\$$upload_session_tmp = \"${SESSPATH}\";" >> \
	     php/config.php
	echo "\$$service_name = \"@service_name@\";" >> php/config.php
	echo "\$$service_url = \"@service_url@\";" >> php/config.php
	echo "\$$secure_service_url = \"@secure_service_url@\";" >> \
	     php/config.php
	echo "\$$sdb_host = \"@sdb_host@\";" >> \
	     php/config.php
	echo "\$$sdb_name = \"@sdb_name@\";" >> \
	     php/config.php
	echo "\$$sdb_ro_user = \"@sdb_ro_user@\";" >> \
	     php/config.php
	echo "\$$sdb_ro_password = \"@sdb_ro_password@\";" >> \
	     php/config.php
	echo "\$$allow_support_logging = \"@allow_support_logging@\";" >> \
	     php/config.php
	echo "define( \"PATHTOIMGS\", \"${ROOTDIR}/images/mime/small/\" );" >> \
	     php/config.php
	echo '?>' >> php/config.php

php/version.php: VERSION
	rm -f php/version.php
	echo '<?php' >> php/version.php
	echo '# php version file generated by Makefile.' >> php/version.php
	echo "\$$filedrawers_version = \"`cat VERSION`\";" >>  \
	     php/version.php
	echo '?>' >> php/version.php

install: all
	mkdir -p ${ROOTDIR}
	chmod 775 ${ROOTDIR}
	chgrp @install_group@ ${ROOTDIR}
	mkdir -p ${SESSPATH}
	chmod 700 ${SESSPATH}

	mkdir -p ${SHTMLDIR}
	chmod 775 ${SHTMLDIR}
	chgrp @install_group@ ${SHTMLDIR}
	for i in ${SHTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SHTMLDIR}/; \
	done

	# Copy filemanager index into shtml index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_filemanager.php \
	           ${SHTMLDIR}/index.php

        # Install Images
	mkdir -p ${IMAGES}
	chmod 0775 ${IMAGES}
	chgrp @install_group@ ${IMAGES}
	for i in ${IMAGETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${IMAGES}/; \
	done

        # Install mime images.
	cp -R images/mime ${IMAGES}
	chmod -R 0775 ${IMAGES}/mime
	chgrp -R @install_group@ ${IMAGES}/mime

	mkdir -p ${HTMLDIR}
	chmod 775 ${HTMLDIR}
	chgrp @install_group@ ${HTMLDIR}
	for i in ${HTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${HTMLDIR}/; \
	done

	# Copy html index into html index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_html.php \
	           ${HTMLDIR}/index.php

	mkdir -p ${JSDIR}
	chmod 775 ${JSDIR}
	chgrp @install_group@ ${JSDIR}
	for i in ${JSDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${JSDIR}/; \
	done

	mkdir -p ${CSSDIR}
	chmod 775 ${CSSDIR}
	chgrp @install_group@ ${CSSDIR}
	for i in ${CSSDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${CSSDIR}/; \
	done

	mkdir -p ${OBJDIR}
	chmod 775 ${OBJDIR}
	chgrp @install_group@ ${OBJDIR}
	for i in ${OBJDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${OBJDIR}/; \
	done

	mkdir -p ${LIBDIR}
	chmod 775 ${LIBDIR}
	chgrp @install_group@ ${LIBDIR}
	for i in ${LIBDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${LIBDIR}/; \
	done


	mkdir -p ${SMARTY}
	chmod 775 ${SMARTY}
	chgrp @install_group@ ${SMARTY}
	for i in ${SMARTYTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SMARTY}/; \
	done

        # Create smarty templates directory
	mkdir -p ${TEMPLATES}
	chgrp @install_group@ ${TEMPLATES}
	chmod 777 ${TEMPLATES}

	for i in ${TEMPLATETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${TEMPLATES}/; \
	done

	mkdir -p ${TEMPLATES_C}
	chgrp @install_group@ ${TEMPLATES_C}
	chmod 777 ${TEMPLATES_C}

	mkdir -p ${DOWNLOADDIR}
	chmod 775 ${DOWNLOADDIR}
	chgrp @install_group@ ${DOWNLOADDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_download.php \
	           ${DOWNLOADDIR}/index.php
	$(INSTALL) -g @install_group@ -m 0775 php/view.php \
	           ${DOWNLOADDIR}/view.php

	mkdir -p ${CGIDIR}
	chmod 755 ${CGIDIR}
	chgrp @install_group@ ${CGIDIR}
	$(INSTALL) -g @install_group@ -m 0775 upload/upload.cgi \
	           ${CGIDIR}/upload.cgi

        # Install make-webspace
	mkdir -p ${MWSDIR}
	chmod 755 ${MWSDIR}
	chgrp @install_group@ ${MWSDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_makewebspace.php \
	           ${MWSDIR}/index.php

        # Install allow-support
	mkdir -p ${ASDIR}
	chmod 755 ${ASDIR}
	chgrp @install_group@ ${ASDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_allowsupport.php \
	           ${ASDIR}/index.php

        # Install admin-support
	mkdir -p ${ADMINDIR}
	chmod 755 ${ADMINDIR}
	chgrp @install_group@ ${ADMINDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_adminsupport.php \
	           ${ADMINDIR}/index.php

	@echo "***************************************************************"
	@echo "Please remember to chown ${SESSPATH} to the user"
	@echo "your web server runs as."
	@echo "***************************************************************"
clean :
	cd libcgi; ${MAKE} ${MFLAGS} clean
	rm -f upload/*.o upload/a.out upload/*.core upload/upload.cgi
	rm -f php/config.php
