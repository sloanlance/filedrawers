SHELL = /bin/sh

srcdir =        @srcdir@
VPATH =		@srcdir@

OPTOPTS=        -Wall -Wmissing-prototypes -Wstrict-prototypes
CC=             @CC@
INSTALL=        @INSTALL@

PHPIZE=		@phpize@

# Configured directory names
ROOTDIR=@prefix@/@project_name@
SHTMLDIR=${ROOTDIR}/@shtml_dir_name@
HTMLDIR=${ROOTDIR}/@html_dir_name@
OBJDIR=${ROOTDIR}/@object_dir_name@
SMARTY=${ROOTDIR}/@smarty_dir_name@
CGIDIR=${ROOTDIR}/@cgi_dir_name@
LIBDIR=${ROOTDIR}/@lib_dir_name@
JSDIR=${ROOTDIR}/@js_dir_name@
CSSDIR=${ROOTDIR}/@css_dir_name@
IMAGES=${ROOTDIR}/images

# Derived directory names
MWSDIR=${SHTMLDIR}/make-webspace
ASDIR=${SHTMLDIR}/allow-support
ADMINDIR=${SHTMLDIR}/admin-support
DOWNLOADDIR=${SHTMLDIR}/download
TEMPLATES=${SMARTY}/templates
TEMPLATES_C=${SMARTY}/templates_c

CFLAGS=         ${OPTOPTS} @CFLAGS@ -g -O2

SHTMLDIRTARGET= php/addfavorites.php php/deletefavorites.php \
                php/perm_manager.php php/progress.php \
                php/renamefavorites.php php/viewfavorites.php \
                php/blankpage.html php/scripterror.php php/help.php \
                php/scriptversion.php php/view.php \
				php/upload-info-server.php php/missinghomedir.php

HTMLDIRTARGET=  php/feedback.php

OBJDIRTARGET=   php/afs.php php/favorites.php php/mime.php \
                php/webspaces.php php/affiliations.php \
                php/supportgroups.php php/session.php

LIBDIRTARGET=   php/config.php php/libdrawers.php \
                php/version.php upload/filedrawers.conf

SMARTYTARGET=   smarty/smarty.custom.php

TEMPLATETARGET= smarty/fileman.tpl smarty/makewebspace.tpl \
                smarty/allowsupport.tpl smarty/adminsupport.tpl \
                smarty/adminsupport_noauth.tpl \
                smarty/addFavorites.tpl smarty/deleteFavorites.tpl \
                smarty/footer.tpl smarty/masthead.tpl \
                smarty/permissions.tpl smarty/renameFavorites.tpl \
                smarty/viewFavorites.tpl smarty/sidebar.tpl \
                smarty/filelist.tpl smarty/fileman.tpl \
                smarty/banner.tpl smarty/infobar.tpl \
				smarty/scripterror.tpl smarty/header.tpl \
				smarty/help.tpl smarty/scriptversion.tpl \
				smarty/viewfile.tpl smarty/missinghomedir.tpl

IMAGETARGET=    images/checkbox.gif images/doc_lg.gif \
                images/doc_sm.gif images/download.gif \
                images/folder.gif images/folder_locked.gif \
                images/sort_ascend.gif images/sort_decend.gif \
                images/text.gif images/support_remove.gif \
                images/support_give.gif \
                images/blue_tabcap_r.gif images/bulb_large.gif \
                images/bulb_small.gif images/first_time.gif \
                images/header_afs_cabinet.gif images/header_text_afs.gif \
                images/link_arrow.gif images/login-anim.gif \
                images/searchtab_l.gif images/searchtab_r.gif \
                images/spacer.gif

JSDIRTARGET=    js/filemanage.js js/allowsupport.js

CSSDIRTARGET=   css/adminsupport.css css/allowsupport.css \
		css/favorites.css css/fileman.css \
		css/ie5specific.css css/ie6specific.css \
		css/makewebspace.css css/styles.css

all: php/version.php php/config.php upload/filedrawers.conf php-pecl upload/upload.cgi

upload/upload.cgi: libcgi/libcgi.a
	( cd upload; ${MAKE} ${MFLAGS} )

libcgi/libcgi.a:
	cd libcgi; ${MAKE} ${MFLAGS}

php-pecl :
	( cd pecl; ${MAKE} ${MFLAGS} )

pecl-test :
	( cd pecl; ${MAKE} ${MFLAGS} test )

pecl-clean :
	( cd pecl; ${MAKE} ${MFLAGS} clean )

pecl-phpize-clean :
	( cd pecl; ${PHPIZE} --clean )

pecl-install :
	( cd pecl; ${MAKE} ${MFLAGS} install )

php/config.php: Makefile
	rm -f php/config.php
	echo '<?php' >> php/config.php
	echo '# php config file generated by Makefile.' >> php/config.php
	echo "\$$service_name = \"@service_name@\";" >> php/config.php
	echo "\$$service_url = \"@service_url@\";" >> php/config.php
	echo "\$$secure_service_url = \"@secure_service_url@\";" >> \
	     php/config.php
	echo "define( \"DB_HOST\", \"@db_host@\" );" >> \
	     php/config.php
	echo "define( \"DB_NAME\", \"@db_name@\" );" >> \
	     php/config.php
	echo "define( \"DB_RO_USER\", \"@db_ro_user@\" );" >> \
	     php/config.php
	echo "define( \"DB_RO_PASS\", \"@db_ro_password@\" );" >> \
	     php/config.php
	echo "define( \"DB_USER\", \"@db_user@\" );" >> \
	     php/config.php
	echo "define( \"DB_PASS\", \"@db_password@\" );" >> \
	     php/config.php
	echo "\$$allow_support_logging = \"@allow_support_logging@\";" >> \
	     php/config.php
	echo "define( \"PATHTOIMGS\", \"${ROOTDIR}/images/mime/small/\" );" >> \
	     php/config.php
	echo '?>' >> php/config.php

upload/filedrawers.conf: Makefile
	rm -f upload/filedrawers.conf
	echo '# CGI config file generated by Makefile.' >> upload/filedrawers.conf
	echo '' >> upload/filedrawers.conf
	echo '# mysql settings for progress feedback' >> upload/filedrawers.conf
	echo "progressdbhost          @db_host@" >> upload/filedrawers.conf
	echo "progressdblogin         @db_user@" >> upload/filedrawers.conf
	echo "progressdbpassword      @db_password@" >> upload/filedrawers.conf
	echo "progressdbname          @db_name@" >> upload/filedrawers.conf
	echo "progressdbtable         @progressdbtable@" >> upload/filedrawers.conf
	echo "" >> upload/filedrawers.conf
	echo "# only uploads to subdirectories of this path are valid" >> \
	     upload/filedrawers.conf
	echo "validpath               @valid_fs_path@" >> upload/filedrawers.conf
	echo "" >> upload/filedrawers.conf
	echo "# redirect here on error" >> upload/filedrawers.conf
	echo "errorurl                @error_url@" >> upload/filedrawers.conf

php/version.php: VERSION
	rm -f php/version.php
	echo '<?php' >> php/version.php
	echo '# php version file generated by Makefile.' >> php/version.php
	echo "\$$filedrawers_version = \"`cat VERSION`\";" >>  \
	     php/version.php
	echo '?>' >> php/version.php

install: all pecl-install
	mkdir -p ${ROOTDIR}
	chmod 775 ${ROOTDIR}
	chgrp @install_group@ ${ROOTDIR}

	mkdir -p ${SHTMLDIR}
	chmod 775 ${SHTMLDIR}
	chgrp @install_group@ ${SHTMLDIR}
	for i in ${SHTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SHTMLDIR}/; \
	done

	# Copy filemanager index into shtml index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_filemanager.php \
	           ${SHTMLDIR}/index.php

        # Install Images
	mkdir -p ${IMAGES}
	chmod 0775 ${IMAGES}
	chgrp @install_group@ ${IMAGES}
	for i in ${IMAGETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${IMAGES}/; \
	done

        # Install mime images.
	cp -R images/mime ${IMAGES}
	chmod -R 0775 ${IMAGES}/mime
	chgrp -R @install_group@ ${IMAGES}/mime

	mkdir -p ${HTMLDIR}
	chmod 775 ${HTMLDIR}
	chgrp @install_group@ ${HTMLDIR}
	for i in ${HTMLDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${HTMLDIR}/; \
	done

	# Copy html index into html index.
	$(INSTALL) -g @install_group@ -m 0775 php/index_html.php \
	           ${HTMLDIR}/index.php

	mkdir -p ${JSDIR}
	chmod 775 ${JSDIR}
	chgrp @install_group@ ${JSDIR}
	for i in ${JSDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${JSDIR}/; \
	done

	mkdir -p ${CSSDIR}
	chmod 775 ${CSSDIR}
	chgrp @install_group@ ${CSSDIR}
	for i in ${CSSDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0664 -c $$i ${CSSDIR}/; \
	done

	mkdir -p ${OBJDIR}
	chmod 775 ${OBJDIR}
	chgrp @install_group@ ${OBJDIR}
	for i in ${OBJDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${OBJDIR}/; \
	done

	mkdir -p ${LIBDIR}
	chmod 775 ${LIBDIR}
	chgrp @install_group@ ${LIBDIR}
	for i in ${LIBDIRTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${LIBDIR}/; \
	done


	mkdir -p ${SMARTY}
	chmod 775 ${SMARTY}
	chgrp @install_group@ ${SMARTY}
	for i in ${SMARTYTARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${SMARTY}/; \
	done

        # Create smarty templates directory
	mkdir -p ${TEMPLATES}
	chgrp @install_group@ ${TEMPLATES}
	chmod 777 ${TEMPLATES}

	for i in ${TEMPLATETARGET}; do \
		$(INSTALL) -g @install_group@ -m 0775 -c $$i ${TEMPLATES}/; \
	done

	mkdir -p ${TEMPLATES_C}
	chgrp @install_group@ ${TEMPLATES_C}
	chmod 777 ${TEMPLATES_C}

	mkdir -p ${DOWNLOADDIR}
	chmod 775 ${DOWNLOADDIR}
	chgrp @install_group@ ${DOWNLOADDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_download.php \
	           ${DOWNLOADDIR}/index.php
	$(INSTALL) -g @install_group@ -m 0775 php/view.php \
	           ${DOWNLOADDIR}/view.php

	mkdir -p ${CGIDIR}
	chmod 755 ${CGIDIR}
	chgrp @install_group@ ${CGIDIR}
	$(INSTALL) -g @install_group@ -m 0775 upload/upload.cgi \
	           ${CGIDIR}/upload.cgi

        # Install make-webspace
	mkdir -p ${MWSDIR}
	chmod 755 ${MWSDIR}
	chgrp @install_group@ ${MWSDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_makewebspace.php \
	           ${MWSDIR}/index.php

        # Install allow-support
	mkdir -p ${ASDIR}
	chmod 755 ${ASDIR}
	chgrp @install_group@ ${ASDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_allowsupport.php \
	           ${ASDIR}/index.php

        # Install admin-support
	mkdir -p ${ADMINDIR}
	chmod 755 ${ADMINDIR}
	chgrp @install_group@ ${ADMINDIR}
	$(INSTALL) -g @install_group@ -m 0775 php/index_adminsupport.php \
	           ${ADMINDIR}/index.php

VERSION=$(shell cat VERSION)
DISTDIR=../filedrawers-${VERSION}

dist : distclean
	mkdir "${DISTDIR}"
	tar -h -c -f - -X EXCLUDE . | tar xpf - -C "${DISTDIR}"
	echo ${VERSION} > "${DISTDIR}"/VERSION
	tar cvfz "${DISTDIR}".tar.gz "${DISTDIR}"

clean : pecl-clean
	cd libcgi; ${MAKE} ${MFLAGS} clean
	cd upload; ${MAKE} ${MFLAGS} clean
	rm -f php/config.php
	rm -f upload/filedrawers.conf

distclean: clean pecl-phpize-clean
	rm -f config.log config.status Makefile
	rm -rf autom4te.cache .#*
